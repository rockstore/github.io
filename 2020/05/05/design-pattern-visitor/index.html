<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/go/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/go/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/go/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/go/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/go/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/go/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/go/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="访问者模式前言访问者模式是一种行为模式，是比较复杂的一种设计模式，相较于单例、工厂、抽象工厂等常用的设计模式，访问者模式在平时开发过程中用到的也比较少，但在合理的场景选择访问者模式会让系统扩展性大大提高。 ASM 对字节码的修改用到了访问者模式，本文会基于 ASM 对字节码的修改做访问者模式的使用分析。 定义在《 Android 源码设计模式解析与实战》中，是这样定义访问者模式的：封装一些作用于某">
<meta property="og:type" content="article">
<meta property="og:title" content="访问者模式">
<meta property="og:url" content="https://rockstore.github.io/go/2020/05/05/design-pattern-visitor/index.html">
<meta property="og:site_name" content="Rock">
<meta property="og:description" content="访问者模式前言访问者模式是一种行为模式，是比较复杂的一种设计模式，相较于单例、工厂、抽象工厂等常用的设计模式，访问者模式在平时开发过程中用到的也比较少，但在合理的场景选择访问者模式会让系统扩展性大大提高。 ASM 对字节码的修改用到了访问者模式，本文会基于 ASM 对字节码的修改做访问者模式的使用分析。 定义在《 Android 源码设计模式解析与实战》中，是这样定义访问者模式的：封装一些作用于某">
<meta property="og:image" content="http://p0.qhimg.com/t01893144855515aca9.png">
<meta property="og:image" content="http://p0.qhimg.com/t01bf959da4be6ef620.png">
<meta property="og:image" content="http://p0.qhimg.com/t018960ce5e8164de30.png">
<meta property="og:image" content="http://p0.qhimg.com/t018c5e67cc558562a0.png">
<meta property="article:published_time" content="2020-05-05T01:59:08.000Z">
<meta property="article:modified_time" content="2020-05-05T01:59:57.565Z">
<meta property="article:author" content="rockstore">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://p0.qhimg.com/t01893144855515aca9.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/go/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://rockstore.github.io/go/2020/05/05/design-pattern-visitor/"/>





  <title>访问者模式 | Rock</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/go/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Rock</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/go/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/go/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/go/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/go/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://rockstore.github.io/go/go/2020/05/05/design-pattern-visitor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="rockstore">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/go/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rock">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">访问者模式</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-05T09:59:08+08:00">
                2020-05-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/go/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="访问者模式"><a href="#访问者模式" class="headerlink" title="访问者模式"></a>访问者模式</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>访问者模式是一种行为模式，是比较复杂的一种设计模式，相较于单例、工厂、抽象工厂等常用的设计模式，访问者模式在平时开发过程中用到的也比较少，但在合理的场景选择访问者模式会让系统扩展性大大提高。 ASM 对字节码的修改用到了访问者模式，本文会基于 ASM 对字节码的修改做访问者模式的使用分析。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>在《 Android 源码设计模式解析与实战》中，是这样定义访问者模式的：封装一些作用于某种数据结构中各元素的操作，它可以在不改变这个数据结构的前提下定义作用于这些元素的操作。不改变数据结构的意思是数据结构保持稳定，修改较少，至于为什么，后面会有说明。</p>
<h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><ul>
<li>对象结构比较稳定，经常需要在此对象结构上定义新的操作。</li>
<li>需要对一个对象结构中的对象进行很多不同的且不相关的操作，而需要避免这些操作“污染”这些对象的类，也不希望在增加新操作时修改这些类。</li>
</ul>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>在实现之前，先不给出访问者模式的 UML 类图，实现完成后再进行总结。</p>
<p>现在有这样一个模拟需求：有华为和苹果两种品牌的手机，男性消费者在选择苹果时，优先考虑苹果手机的价格，在选择华为时，优先考虑华为手机的性能；女性消费者在选择苹果时，优先考虑苹果手机的外观，在选在华为时优先考虑华为手机的价格。现在有一定数量不同型号的苹果和华为手机，销售想知道男性消费者对当前华为手机定价的反馈以及女性消费者对苹果手机屏幕大小的反馈。</p>
<p>既然是分析访问者，就用访问者模式实现以下这个需求。</p>
<p>首先定义手机的抽象父类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MobilePhone</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> price;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Consumer visitor)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> MobilePhone 定义了公共属性手机价格 price , 并定义了 accept 方法。Consumer 类会在后面进行说明。</p>
<p>定义 IPhone 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IPhone</span> <span class="keyword">extends</span> <span class="title">MobilePhone</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> size;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">IPhone</span><span class="params">(<span class="keyword">int</span> price, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">		<span class="keyword">super</span>.price = price;</span><br><span class="line">		<span class="keyword">this</span>.size = size;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Consumer consumer)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		consumer.visit(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> IPhone 类扩展了 MobilePhone 类，定义了屏幕尺寸 size 属性，并实现了 accept 方法</p>
<p>定义 HwPhone 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HwPhone</span> <span class="keyword">extends</span> <span class="title">MobilePhone</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> performance;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HwPhone</span><span class="params">(<span class="keyword">int</span> price, <span class="keyword">int</span> performance)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">		<span class="keyword">super</span>.price = price;</span><br><span class="line">		<span class="keyword">this</span>.performance = performance;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Consumer visitor)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		visitor.visit(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HwPhone 类扩展了 MobilePhone 类，并定义了属性性能 performance</p>
<p>接下来就需要定义消费者了，首先定义消费者的基类 Consumer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IPhone phone)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(HwPhone phone)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义男性消费者 ManConsumer </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManConsumer</span> <span class="keyword">implements</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IPhone phone)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">"man-consumer focus price of iphone:"</span> + phone.price + <span class="string">" too expensive"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(HwPhone phone)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		String msg = phone.performance &gt; <span class="number">100000</span> ? <span class="string">" good"</span> : <span class="string">" bad"</span>;</span><br><span class="line">		System.out.println(<span class="string">"man-consumer focus performance of hwphone:"</span> + phone.performance + msg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义女性消费者 WomanConsumer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WomanConsumer</span> <span class="keyword">implements</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IPhone phone)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		String msg = phone.size &gt; <span class="number">7</span> ? <span class="string">" good"</span> : <span class="string">" bad"</span>;</span><br><span class="line">		System.out.println(<span class="string">"woman-consumers focus on size of iphone:"</span> + phone.size + msg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(HwPhone phone)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">"woman-consumers focus on price of hwphone:"</span> + phone.price + <span class="string">" unworthy"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>既然是调研任务，就把调研任务做一下封装，并添加模拟数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Report</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> ArrayList&lt;MobilePhone&gt; mobilePhones = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Report</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		IPhone phone6 = <span class="keyword">new</span> IPhone(<span class="number">5000</span>, <span class="number">6</span>);</span><br><span class="line">		IPhone phone7 = <span class="keyword">new</span> IPhone(<span class="number">6000</span>, <span class="number">8</span>);</span><br><span class="line">		</span><br><span class="line">		HwPhone honor9 = <span class="keyword">new</span> HwPhone(<span class="number">1500</span>, <span class="number">100000</span>);</span><br><span class="line">		HwPhone honor10 = <span class="keyword">new</span> HwPhone(<span class="number">2300</span>, <span class="number">200000</span>);</span><br><span class="line">		</span><br><span class="line">		mobilePhones.add(phone6);</span><br><span class="line">		mobilePhones.add(phone7);</span><br><span class="line">		mobilePhones.add(honor9);</span><br><span class="line">		mobilePhones.add(honor10);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showResult</span><span class="params">(Consumer consumer)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (MobilePhone phone : mobilePhones) &#123;</span><br><span class="line">			phone.accept(consumer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最后添加一下测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String [] args)</span> </span>&#123;</span><br><span class="line">		Report report = <span class="keyword">new</span> Report();</span><br><span class="line">		</span><br><span class="line">		WomanConsumer womanConsumer = <span class="keyword">new</span> WomanConsumer();</span><br><span class="line">		report.showResult(womanConsumer);</span><br><span class="line">		</span><br><span class="line">		System.out.println();</span><br><span class="line">		</span><br><span class="line">		ManConsumer manConsumer = <span class="keyword">new</span> ManConsumer();</span><br><span class="line">		report.showResult(manConsumer);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>程序运行结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">woman-consumers focus on size of iphone:<span class="number">6</span> bad</span><br><span class="line">woman-consumers focus on size of iphone:<span class="number">8</span> good</span><br><span class="line">woman-consumers focus on price of hwphone:<span class="number">1500</span> unworthy</span><br><span class="line">woman-consumers focus on price of hwphone:<span class="number">2300</span> unworthy</span><br><span class="line"></span><br><span class="line">man-consumer focus price of iphone:<span class="number">5000</span> too expensive</span><br><span class="line">man-consumer focus price of iphone:<span class="number">6000</span> too expensive</span><br><span class="line">man-consumer focus performance of hwphone:<span class="number">100000</span> bad</span><br><span class="line">man-consumer focus performance of hwphone:<span class="number">200000</span> good</span><br></pre></td></tr></table></figure>

<p>进行测试时，分别生成了一个男性消费者 manConsumer 和一个女性消费者 womanConsumer ，然后让这两个消费者分别看了（执行 accept 方法）苹果和华为手机，并根据两种手机的尺寸和价格作出评价（执行 visit 函数）。</p>
<p>给出实现的 uml 结构图</p>
<p><img src="http://p0.qhimg.com/t01893144855515aca9.png" alt=""></p>
<p>其实这一模拟需求，不使用访问者模式也可以实现，可能跟我想的一样，直接使用循环的方式，实现的 uml 如下：</p>
<p><img src="http://p0.qhimg.com/t01bf959da4be6ef620.png" alt=""></p>
<p>使用上述方式进行实现， Consumer 对象在遍历访问 MobilePhone 对象时，由于男性消费者 ManConsumer 更加关注华为手机 HwPhone 的性能，而 IPhone 手机又没有 performance 属性，故需要对 MobilePhone 对象进行强制类型转换，女性消费者在遍历的时候同样也会面临这一问题。</p>
<p>假设现在系统中出现 Oppo 手机，用户比较关注手机的拍照和音乐功能，使用这种方式实现时，需要增加新的类型转换；如果系统中突然出现大量主打不同特性的手机，在进行遍历时就会增加大量 if-else 判断。</p>
<p>使用访问者模式时，如果增加新的手机品牌，只需要在 Consumer 接口中增加新的 visit 函数即可，系统结构更加清晰，灵活度更高。</p>
<h2 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h2><p><img src="http://p0.qhimg.com/t018960ce5e8164de30.png" alt=""></p>
<p>以上是访问者模式的标准实现，对结构进行分析，可以抽象出以下部分：</p>
<ul>
<li><p>Visitor</p>
<p>接口或者是抽象类，它的方法定义了每一个 ConcreteVisitor 的访问行为，方法的参数为 Element 的子类。</p>
</li>
<li><p>ConcreteVisitor</p>
<p>具体的访问者，定义针对每种具体 Element 的访问行为。</p>
</li>
<li><p>Element</p>
<p>被访问元素的基类，定义了 accept 的方法，表示每一个子类都可以被 Visitor 访问。</p>
</li>
<li><p>ConcrementElement</p>
<p>具体的被访问元素。</p>
</li>
<li><p>ObjectStructure</p>
<p>元素的管理单元，一般是元素的集合。</p>
</li>
</ul>
<p>在 前面的定义中，说了“在不改变数据结构的前提下”，为什么需要有这个前提呢？这就要从 ConcreteVisitor 开始分析。每一个 ConcreteVisitor 在被定义后，它的访问行为就会被确定，它的访问行为会严重依赖 Element 的实现，可以参考前面的实现和后面 Android中访问者模式的使用章节。比如在实现章节中， ManConsumer 依赖 HwPhone 的 performance 属性，如果在后面的设计中需要对 performance 属性修改， 则 ManConsumer 必须要进行修改。因此，在使用访问者模式进行设计时，需要考虑被访问的元素是否存在频繁修改的可能性。</p>
<h2 id="Android-中访问者模式的使用"><a href="#Android-中访问者模式的使用" class="headerlink" title="Android 中访问者模式的使用"></a>Android 中访问者模式的使用</h2><p>Android 中访问者模式的使用不是很好找，本文从 HtmlDocument 类入手，分析 HtmlDocument 的构建过程，了解访问者模式在 Android 中的使用， 涉及到的类文件都在 com.android.mail.lib.html.parser 包中。</p>
<p>HtmlDocument 表示 Html 文档，包含了文本( Text )，标签( Tag )，结束标签( EndTag )，注释( Comment )等元素，所有的这些元素称为节点( Node )，Node 定义了抽象的 accept 方法，所有的子类都需要实现此方法，接受 Visitor 的调用，HtmlDocument 包含一个 Node 的集合。 Node 的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Accepts a visitor */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor visitor)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Converts to HTML */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toHTML</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      toHTML(sb);</span><br><span class="line">      <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Converts to HTML */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">toHTML</span><span class="params">(StringBuilder sb)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Converts to XHTML */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toXHTML</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      toXHTML(sb);</span><br><span class="line">      <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Converts to XHTML */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">toXHTML</span><span class="params">(StringBuilder sb)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Original if it's available; otherwise, returns</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;toHTML()&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toOriginalHTML</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      toOriginalHTML(sb);</span><br><span class="line">      <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sb Destination of HTML to be appended.  Appends original if it's</span></span><br><span class="line"><span class="comment">     * available; otherwise, appends &lt;code&gt;toHTML()&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">toOriginalHTML</span><span class="params">(StringBuilder sb)</span></span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>Node 基类定义了所有节点都需要实现的方法，不同的节点如 Text 会定义自己的方法，以便让访问者获取对应的信息。</p>
<p>HtmlDocument 定义了访问者需要实现的接口 Visitor :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">Visitor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** This is called first */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A text node */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">visitText</span><span class="params">(Text n)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** An open tag */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">visitTag</span><span class="params">(Tag n)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** End tag */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">visitEndTag</span><span class="params">(EndTag n)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** comment */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">visitComment</span><span class="params">(Comment n)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Called at the end. */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span></span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>为了构造一个完整的 HtmlDocument 文档，需要遍历 html 文件，然后在遍历过程成将遍历到的节点添加到 Node 集合中。HtmlDocument 的内部类 Builder 实现了 Visitor 接口，在遍历过程中将节点添加到 Node 集合中。 可以看下 HtmlDocument.Builder 的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> <span class="keyword">implements</span> <span class="title">Visitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> preserveComments;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Node&gt; nodes = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</span><br><span class="line">    <span class="keyword">private</span> HtmlDocument doc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> Builder#Builder(boolean)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preserveComments If false, ignores Comment nodes</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(<span class="keyword">boolean</span> preserveComments)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.preserveComments = preserveComments;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNode</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">      nodes.add(node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitText</span><span class="params">(Text t)</span> </span>&#123;</span><br><span class="line">      addNode(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitTag</span><span class="params">(Tag t)</span> </span>&#123;</span><br><span class="line">      addNode(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitComment</span><span class="params">(Comment n)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (preserveComments) &#123;</span><br><span class="line">        addNode(n);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEndTag</span><span class="params">(EndTag t)</span> </span>&#123;</span><br><span class="line">      addNode(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      doc = <span class="keyword">new</span> HtmlDocument(nodes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Gets the html document that has been constructed */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HtmlDocument <span class="title">getDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> doc;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>在 Builder 的内部存在一个 Node 集合 nodes ，在遍历过程中， visitXXX 方法将节点添加到 nodes 中，遍历完成后（执行 finish 方法），根据 nodes 构建一个 HtmlDocument 对象。</p>
<p>可以看下 HtmlDocument ， Node， Text ， Tag ， EndTag ， HtmlDocument.Builder 之间的关系。</p>
<p><img src="http://p0.qhimg.com/t018c5e67cc558562a0.png" alt=""></p>
<p>Visitor 的实现中还添加了 HtmlDocument.VisitorWrapper， HtmlDocument.DebugPrinter， HtmlTreeBuilder 类，可以自行参考源码分析一下。</p>
<h2 id="ASM-中访问者模式的使用"><a href="#ASM-中访问者模式的使用" class="headerlink" title="ASM 中访问者模式的使用"></a>ASM 中访问者模式的使用</h2><p>分析 ASM 中的访问者模式，需要了解 ASM 对 class 文件的修改流程。为了便于进行跨平台， class 文件被设计成了固定的格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123; </span><br><span class="line">    u4 magic; </span><br><span class="line">    u2 minor_version; </span><br><span class="line">    u2 major_version; </span><br><span class="line">    u2 constant_pool_count; </span><br><span class="line">    cp_info constant_pool[constant_pool_count-<span class="number">1</span>]; </span><br><span class="line">    u2 access_flags; </span><br><span class="line">    u2 this_class; </span><br><span class="line">    u2 super_class; </span><br><span class="line">    u2 interfaces_count; </span><br><span class="line">    u2 interfaces[interfaces_count]; </span><br><span class="line">    u2 fields_count; </span><br><span class="line">    field_info fields[fields_count]; </span><br><span class="line">    u2 methods_count; </span><br><span class="line">    method_info methods[methods_count]; </span><br><span class="line">    u2 attributes_count; </span><br><span class="line">    attribute_info attributes[attributes_count]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>class 文件的格式是固定的，也就是说数据结构不发生变化。接下来就来分下 ASM 对 class 文件的修改流程。使用 ASM 对 class 文件修改，需要 ClassReader 负责读取 class 文件， 自定义 ClassVisitor 对 class 进行修改， ClassWriter 输出修改后的 class 。 ClassReader 调用 accept 方法开始 visitXXX 方法的调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class 文件</span></span><br><span class="line"><span class="keyword">byte</span> [] classFile;</span><br><span class="line">ClassReader cr = <span class="keyword">new</span> ClassReader(classFile);</span><br><span class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</span><br><span class="line">CustomVisitor cv = <span class="keyword">new</span> CustomVisitor(Opcodes.ASM6, cw);</span><br><span class="line">cr.accept(cv, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">byte</span> [] result = cw.toByteArray();</span><br></pre></td></tr></table></figure>

<p>以上是使用 ASM 修改字节码的简单的 流程 demo , 流程为 ClassReader 读取 class 文件的字节数组 classFile ,  自定义的 Visitor cv 负责修改字节码，通过责任链最终调用会转发到 ClassWriter cw  ，最后调用 cw.toByteArray 方法获得修改后的字节数组。</p>
<p>为了明白其中的访问者模式，需要看下 accept 方法的实现，代码量比较多，但是跟着注释，逻辑线很清晰。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> ClassVisitor classVisitor,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> Attribute[] attributePrototypes,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> <span class="keyword">int</span> parsingOptions)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// visit class 声明</span></span><br><span class="line">    classVisitor.visit(</span><br><span class="line">        readInt(cpInfoOffsets[<span class="number">1</span>] - <span class="number">7</span>), accessFlags, thisClass, signature, superClass, interfaces);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the SourceFile and SourceDebugExtenstion attributes.</span></span><br><span class="line">    <span class="keyword">if</span> ((parsingOptions &amp; SKIP_DEBUG) == <span class="number">0</span></span><br><span class="line">        &amp;&amp; (sourceFile != <span class="keyword">null</span> || sourceDebugExtension != <span class="keyword">null</span>)) &#123;</span><br><span class="line">      classVisitor.visitSource(sourceFile, sourceDebugExtension);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the Module, ModulePackages and ModuleMainClass attributes.</span></span><br><span class="line">    <span class="keyword">if</span> (moduleOffset != <span class="number">0</span>) &#123;</span><br><span class="line">      readModuleAttributes(</span><br><span class="line">          classVisitor, context, moduleOffset, modulePackagesOffset, moduleMainClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the NestHost attribute.</span></span><br><span class="line">    <span class="keyword">if</span> (nestHostClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">      classVisitor.visitNestHost(nestHostClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the EnclosingMethod attribute.</span></span><br><span class="line">    <span class="keyword">if</span> (enclosingMethodOffset != <span class="number">0</span>) &#123;</span><br><span class="line">      String className = readClass(enclosingMethodOffset, charBuffer);</span><br><span class="line">      <span class="keyword">int</span> methodIndex = readUnsignedShort(enclosingMethodOffset + <span class="number">2</span>);</span><br><span class="line">      String name = methodIndex == <span class="number">0</span> ? <span class="keyword">null</span> : readUTF8(cpInfoOffsets[methodIndex], charBuffer);</span><br><span class="line">      String type = methodIndex == <span class="number">0</span> ? <span class="keyword">null</span> : readUTF8(cpInfoOffsets[methodIndex] + <span class="number">2</span>, charBuffer);</span><br><span class="line">      classVisitor.visitOuterClass(className, name, type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the RuntimeVisibleAnnotations attribute.</span></span><br><span class="line">    <span class="keyword">if</span> (runtimeVisibleAnnotationsOffset != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> numAnnotations = readUnsignedShort(runtimeVisibleAnnotationsOffset);</span><br><span class="line">      <span class="keyword">int</span> currentAnnotationOffset = runtimeVisibleAnnotationsOffset + <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">while</span> (numAnnotations-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Parse the type_index field.</span></span><br><span class="line">        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);</span><br><span class="line">        currentAnnotationOffset += <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// Parse num_element_value_pairs and element_value_pairs and visit these values.</span></span><br><span class="line">        currentAnnotationOffset =</span><br><span class="line">            readElementValues(</span><br><span class="line">                classVisitor.visitAnnotation(annotationDescriptor, <span class="comment">/* visible = */</span> <span class="keyword">true</span>),</span><br><span class="line">                currentAnnotationOffset,</span><br><span class="line">                <span class="comment">/* named = */</span> <span class="keyword">true</span>,</span><br><span class="line">                charBuffer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the RuntimeInvisibleAnnotations attribute.</span></span><br><span class="line">    <span class="keyword">if</span> (runtimeInvisibleAnnotationsOffset != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> numAnnotations = readUnsignedShort(runtimeInvisibleAnnotationsOffset);</span><br><span class="line">      <span class="keyword">int</span> currentAnnotationOffset = runtimeInvisibleAnnotationsOffset + <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">while</span> (numAnnotations-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Parse the type_index field.</span></span><br><span class="line">        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);</span><br><span class="line">        currentAnnotationOffset += <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// Parse num_element_value_pairs and element_value_pairs and visit these values.</span></span><br><span class="line">        currentAnnotationOffset =</span><br><span class="line">            readElementValues(</span><br><span class="line">                classVisitor.visitAnnotation(annotationDescriptor, <span class="comment">/* visible = */</span> <span class="keyword">false</span>),</span><br><span class="line">                currentAnnotationOffset,</span><br><span class="line">                <span class="comment">/* named = */</span> <span class="keyword">true</span>,</span><br><span class="line">                charBuffer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the RuntimeVisibleTypeAnnotations attribute.</span></span><br><span class="line">    <span class="keyword">if</span> (runtimeVisibleTypeAnnotationsOffset != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> numAnnotations = readUnsignedShort(runtimeVisibleTypeAnnotationsOffset);</span><br><span class="line">      <span class="keyword">int</span> currentAnnotationOffset = runtimeVisibleTypeAnnotationsOffset + <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">while</span> (numAnnotations-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Parse the target_type, target_info and target_path fields.</span></span><br><span class="line">        currentAnnotationOffset = readTypeAnnotationTarget(context, currentAnnotationOffset);</span><br><span class="line">        <span class="comment">// Parse the type_index field.</span></span><br><span class="line">        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);</span><br><span class="line">        currentAnnotationOffset += <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// Parse num_element_value_pairs and element_value_pairs and visit these values.</span></span><br><span class="line">        currentAnnotationOffset =</span><br><span class="line">            readElementValues(</span><br><span class="line">                classVisitor.visitTypeAnnotation(</span><br><span class="line">                    context.currentTypeAnnotationTarget,</span><br><span class="line">                    context.currentTypeAnnotationTargetPath,</span><br><span class="line">                    annotationDescriptor,</span><br><span class="line">                    <span class="comment">/* visible = */</span> <span class="keyword">true</span>),</span><br><span class="line">                currentAnnotationOffset,</span><br><span class="line">                <span class="comment">/* named = */</span> <span class="keyword">true</span>,</span><br><span class="line">                charBuffer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the RuntimeInvisibleTypeAnnotations attribute.</span></span><br><span class="line">    <span class="keyword">if</span> (runtimeInvisibleTypeAnnotationsOffset != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> numAnnotations = readUnsignedShort(runtimeInvisibleTypeAnnotationsOffset);</span><br><span class="line">      <span class="keyword">int</span> currentAnnotationOffset = runtimeInvisibleTypeAnnotationsOffset + <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">while</span> (numAnnotations-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Parse the target_type, target_info and target_path fields.</span></span><br><span class="line">        currentAnnotationOffset = readTypeAnnotationTarget(context, currentAnnotationOffset);</span><br><span class="line">        <span class="comment">// Parse the type_index field.</span></span><br><span class="line">        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);</span><br><span class="line">        currentAnnotationOffset += <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// Parse num_element_value_pairs and element_value_pairs and visit these values.</span></span><br><span class="line">        currentAnnotationOffset =</span><br><span class="line">            readElementValues(</span><br><span class="line">                classVisitor.visitTypeAnnotation(</span><br><span class="line">                    context.currentTypeAnnotationTarget,</span><br><span class="line">                    context.currentTypeAnnotationTargetPath,</span><br><span class="line">                    annotationDescriptor,</span><br><span class="line">                    <span class="comment">/* visible = */</span> <span class="keyword">false</span>),</span><br><span class="line">                currentAnnotationOffset,</span><br><span class="line">                <span class="comment">/* named = */</span> <span class="keyword">true</span>,</span><br><span class="line">                charBuffer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the non standard attributes.</span></span><br><span class="line">    <span class="keyword">while</span> (attributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Copy and reset the nextAttribute field so that it can also be used in ClassWriter.</span></span><br><span class="line">      Attribute nextAttribute = attributes.nextAttribute;</span><br><span class="line">      attributes.nextAttribute = <span class="keyword">null</span>;</span><br><span class="line">      classVisitor.visitAttribute(attributes);</span><br><span class="line">      attributes = nextAttribute;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the NestedMembers attribute.</span></span><br><span class="line">    <span class="keyword">if</span> (nestMembersOffset != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> numberOfNestMembers = readUnsignedShort(nestMembersOffset);</span><br><span class="line">      <span class="keyword">int</span> currentNestMemberOffset = nestMembersOffset + <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">while</span> (numberOfNestMembers-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        classVisitor.visitNestMember(readClass(currentNestMemberOffset, charBuffer));</span><br><span class="line">        currentNestMemberOffset += <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the InnerClasses attribute.</span></span><br><span class="line">    <span class="keyword">if</span> (innerClassesOffset != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> numberOfClasses = readUnsignedShort(innerClassesOffset);</span><br><span class="line">      <span class="keyword">int</span> currentClassesOffset = innerClassesOffset + <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">while</span> (numberOfClasses-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        classVisitor.visitInnerClass(</span><br><span class="line">            readClass(currentClassesOffset, charBuffer),</span><br><span class="line">            readClass(currentClassesOffset + <span class="number">2</span>, charBuffer),</span><br><span class="line">            readUTF8(currentClassesOffset + <span class="number">4</span>, charBuffer),</span><br><span class="line">            readUnsignedShort(currentClassesOffset + <span class="number">6</span>));</span><br><span class="line">        currentClassesOffset += <span class="number">8</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the fields and methods.</span></span><br><span class="line">    <span class="keyword">int</span> fieldsCount = readUnsignedShort(currentOffset);</span><br><span class="line">    currentOffset += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span> (fieldsCount-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      currentOffset = readField(classVisitor, context, currentOffset);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> methodsCount = readUnsignedShort(currentOffset);</span><br><span class="line">    currentOffset += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span> (methodsCount-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      currentOffset = readMethod(classVisitor, context, currentOffset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visit the end of the class.</span></span><br><span class="line">    classVisitor.visitEnd();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>accept 的代码有点多，不过看代码的逻辑很清晰，就是不断读取 ClassFile 的文件结构，然后根据文件结构调用对用的 ClassVisitor 的 visitXXX 方法。将上面的代码抽离一下，可以发现就是根据 ClassFile 的文件结构调用了 ClassVisitor 的以下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">visit();</span><br><span class="line">visitSource();</span><br><span class="line">visitOuterClass();</span><br><span class="line">visitAnnotation();</span><br><span class="line">visitTypeAnnotation();</span><br><span class="line">visitAttribute();</span><br><span class="line">visitInnerClass();</span><br><span class="line">visitField();</span><br><span class="line">visitMethod();</span><br><span class="line">visitEnd();</span><br></pre></td></tr></table></figure>

<p>调用这些方法后，最终的 class 文件是如何被修改的呢？在 accept 方法体中， clssVisitor 实例是我们自定义的 CustomVisitor 。跟踪一下 visitFiled 方法， visitField 方法负责分析访问 class 文件的属性声明，执行 CustomVisitor 的 visitField 时，我们可以根据自己的逻辑，修改 visitField 里的参数以达到修改属性的目的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classVisitor.visitField(accessFlags, name, descriptor, signature, constantValue);</span><br></pre></td></tr></table></figure>

<p>以上是 accept 方法体内的一个 visitField 方法调用，参数分别是 属性的访问标识，名称，描述，签名以及常量值。继续跟踪下 visitField 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">visitField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> <span class="keyword">int</span> access,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> String name,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> String descriptor,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> String signature,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cv != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cv.visitField(access, name, descriptor, signature, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>前面申明 CustomVisitor 时，传递了 ClassWriter 作为参数，故此处的 cv 就是 ClassWriter 。ok， 再看下 ClassWriter 的 visitField 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> FieldVisitor <span class="title">visitField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">int</span> access,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String name,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String descriptor,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String signature,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> Object value)</span> </span>&#123;</span><br><span class="line">    FieldWriter fieldWriter =</span><br><span class="line">        <span class="keyword">new</span> FieldWriter(symbolTable, access, name, descriptor, signature, value);</span><br><span class="line">    <span class="keyword">if</span> (firstField == <span class="keyword">null</span>) &#123;</span><br><span class="line">        firstField = fieldWriter;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lastField.fv = fieldWriter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lastField = fieldWriter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行完 ClassWriter 的 visitField 方法后， 属性声明就被 ClassWriter 已链表的方式保存起来。</p>
<p>经过修改后，调用 ClassWriter 的 toByteArray 方法，获得修改后的 class 文件的字节码数组。toByteArray 的代码就不做分析了，主要作用就是根据调用的 visitXXX 方法后记录的 class 文件结构，输出修改后的 byte 数组。</p>
<p>ASM 充分利用了 class 文件格式基本不会改变的特性。 ClassReader 通过读取整个 class 文件，可以将 ClassReader 理解为 访问者模式中的存储元素集合的位置， ClassWriter 和我们自定义的 ClassVisitor 是 Visitor 的具体实现。ClassReader 在不断遍历 class 文件的元素时会根据 class 文件的结构不断调用 ClassVisitor 对应的 visitXXX 方法， ClassVisitor 的 visitXXX 方法负责对 class 文件对应的元素进行修改，最终的修改会通过责任链的形式转发到 ClassWriter 的 visitXXX 方法中， ClassWriter 的 visitXXX 方法会记录最终的修改。最后调用 ClassWriter 的 toByteArray 方法输出修改后的 class 文件的字节数组表示。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>使用访问者模式，使得数据结构和作用于数据上的操作解耦，基于当前的数据结构添加新的操作非常容易，具有优秀的扩展，系统层次清晰。但访问者模式限制了对数据结构的修改，如果需要修改数据结构，西东需要做较大的改动；使用访问者模式时，需要暴露数据结构，违反了迪米特法则；还可以发现，我们在定义 Visitor 接口中的方法时，所有的 visit 接口均依赖具体的类，而不是抽象。</p>
<p>在尝试使用访问者模式时，需要修改考虑的系统中的数据结构是否经常变化，如果数据结构基本不会发生改变，且针对数据结构的操作需要区分具体的类型，就可以考虑使用访问者模式。</p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>   1.《 Android 源码设计模式解析与实战》</p>
<p>   2.访问者模式讨论篇：java的动态绑定与双分派</p>
<pre><code>http://www.importnew.com/15574.html</code></pre><p>   3.Java字节码处理框架ASM设计思想解析</p>
<pre><code>https://www.jianshu.com/p/26e99d39b3fb</code></pre><p>   4.设计模式之访问者模式</p>
<pre><code>https://blog.csdn.net/u012124438/article/details/70537203</code></pre><p>   5.JAVA设计模式（23）：行为型-访问者模式（Visitor）</p>
<pre><code>https://blog.csdn.net/taozi8023/article/details/51457616</code></pre><p>   6.《JAVA设计模式》之访问者模式( Visitor )</p>
<pre><code>https://www.cnblogs.com/betterboyz/p/9378093.html</code></pre>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/go/2020/05/05/design-pattern-proxy/" rel="next" title="代理模式">
                <i class="fa fa-chevron-left"></i> 代理模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/go/2020/05/05/design-pattern-template/" rel="prev" title="模板模式">
                模板模式 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">rockstore</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/go/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/go/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/go/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#访问者模式"><span class="nav-number">1.</span> <span class="nav-text">访问者模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义"><span class="nav-number">1.2.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适用场景"><span class="nav-number">1.3.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现"><span class="nav-number">1.4.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UML"><span class="nav-number">1.5.</span> <span class="nav-text">UML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-中访问者模式的使用"><span class="nav-number">1.6.</span> <span class="nav-text">Android 中访问者模式的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ASM-中访问者模式的使用"><span class="nav-number">1.7.</span> <span class="nav-text">ASM 中访问者模式的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.8.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录"><span class="nav-number">1.9.</span> <span class="nav-text">附录</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rockstore</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/go/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/go/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/go/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/go/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/go/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/go/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/go/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/go/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/go/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/go/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/go/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
